<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Rentman Project Manager</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body { 
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 0.5rem;
    }
    
    .container { 
      display: flex;
      flex-direction: row;
      max-width: 1800px;
      margin: 0 auto;
      align-items: flex-start;
    }
    
    .header {
      background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
      color: white;
      padding: 0 1rem 0 1rem;
      margin-bottom: 0;
      text-align: center;
      width: 100%;
      border-radius: 12px 12px 0 0;
    }
    
    .header h1 {
      font-size: 2rem;
      font-weight: 300;
      margin-bottom: 0.5rem;
    }
    
    .header p {
      opacity: 0.8;
      font-size: 1rem;
    }
    
    .token-status {
      margin-top: 10px;
      padding: 8px 15px;
      border-radius: 20px;
      display: inline-block;
      font-size: 0.85rem;
      font-weight: 500;
    }
    
    .token-valid {
      background-color: #27ae60;
    }
    
    .token-invalid {
      background-color: #e67e22;
    }
    
    .token-error {
      background-color: #e74c3c;
    }
    
    .content {
      padding: 0.1rem 0 0.2rem 0;
      flex: 1 1 0;
      min-width: 0;
    }
    
    .btn {
      padding: 0.6rem 1rem;
      border: none; 
      border-radius: 8px; 
      font-weight: 600; 
      font-size: 0.95rem;
      cursor: pointer;
      transition: all 0.3s ease;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
    }
    
    .btn-primary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      box-shadow: 0 4px 15px rgba(102, 126, 234, 0.2);
    }
    
    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
    }
    
    .btn-secondary {
      background: linear-gradient(135deg, #2196F3 0%, #21CBF3 100%);
      color: white;
      box-shadow: 0 4px 15px rgba(33, 150, 243, 0.2);
    }
    
    .btn-secondary:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(33, 150, 243, 0.4);
    }
    
    .btn-success {
      background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
      color: white;
      box-shadow: 0 4px 15px rgba(40, 167, 69, 0.2);
    }
    
    .btn-success:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(40, 167, 69, 0.4);
    }
    
    .btn:disabled {
      background: #6c757d;
      cursor: not-allowed;
      transform: none !important;
      box-shadow: none !important;
    }
    
    .stats {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 0.5rem;
      padding: 0.5rem;
      background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
      border-radius: 6px;
      border-left: 4px solid #667eea;
    }
    
    .stats-item {
      text-align: center;
    }
    
    .stats-number {
      font-size: 1.5rem;
      font-weight: 700;
      color: #2c3e50;
    }
    
    .stats-label {
      font-size: 0.8rem;
      color: #6c757d;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .table-container { 
      height: 700px; 
      overflow-y: auto; 
      border: 2px solid #e9ecef;
      border-radius: 8px;
      background: white;
      margin-top: 0.2rem;
    }
    
    table { 
      width: 100%; 
      border-collapse: separate; 
      border-spacing: 0; 
      font-size: 0.9rem; 
    }
    
    th, td { 
      padding: 0.5rem 0.4rem;
      text-align: left; 
      border-bottom: 1px solid #e9ecef;
    }
    
    th { 
      background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
      font-weight: 600;
      color: #495057;
      position: sticky; 
      top: 0; 
      z-index: 10;
      text-transform: uppercase;
      font-size: 0.8rem;
      letter-spacing: 0.5px;
    }
    
    tbody tr {
      transition: all 0.2s ease;
    }
    
    tbody tr:hover { 
      background-color: #f8f9fa;
    }
    
    input[type="checkbox"] {
      width: 18px;
      height: 18px;
      margin: 0;
      cursor: pointer;
      accent-color: #667eea;
    }
    
    th:first-child, td:first-child {
      width: 50px;
      text-align: center;
    }
    
    .selected-row {
      background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%) !important;
      border-left: 4px solid #2196F3;
    }
    
    .badge {
      display: inline-block;
      padding: 0.25rem 0.75rem;
      font-size: 0.75rem;
      font-weight: 600;
      border-radius: 12px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .badge-success { background: #d4edda; color: #155724; }
    .badge-warning { background: #fff3cd; color: #856404; }
    .badge-info { background: #d1ecf1; color: #0c5460; }
    .badge-secondary { background: #e2e3e5; color: #383d41; }
    
    @media (max-width: 768px) {
      body {
        padding: 0.2rem;
      }
      
      .header h1 {
        font-size: 1.5rem;
      }
      
      .config-section {
        padding: 1.5rem;
      }
      
      .config-grid {
        grid-template-columns: 1fr !important;
      }
      
      .btn-grid {
        grid-template-columns: 1fr !important;
      }
      
      .sidebar-config {
        padding: 0.5rem 0.3rem;
        height: auto;
        min-height: unset;
      }
      
      .header {
        padding: 0.1rem 0.5rem 0.1rem 0.5rem;
      }
    }
    
    /* Sidebar configurazione: tutta altezza viewport */
    .sidebar-config {
      width: 340px;
      min-width: 280px;
      max-width: 400px;
      background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%);
      border-radius: 12px;
      border: 1px solid #e9ecef;
      box-shadow: 0 4px 20px rgba(0,0,0,0.08);
      margin-right: 1rem;
      padding: 1rem 0.7rem;
      position: sticky;
      top: 0.5rem;
      height: calc(100vh - 1rem);
      min-height: calc(100vh - 1rem);
      align-self: stretch;
      display: flex;
      flex-direction: column;
      justify-content: flex-start;
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Sidebar configurazione -->
    <aside class="sidebar-config" style="width: 340px; min-width: 280px; max-width: 400px; background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%); border-radius: 12px; border: 1px solid #e9ecef; box-shadow: 0 4px 20px rgba(0,0,0,0.08); margin-right: 1rem; padding: 1rem 0.7rem; height: fit-content; align-self: flex-start;">
      <h3 style="color: #2c3e50; margin-bottom: 1.5rem; font-weight: 500; font-size: 1.2rem; display: flex; align-items: center; gap: 0.5rem;">‚öôÔ∏è Configurazione Sistema</h3>
      <form id="importForm" enctype="multipart/form-data">
        <div class="config-grid" style="display: grid; grid-template-columns: 1fr; gap: 1rem; margin-bottom: 1.5rem;">
          <div>
            <label for="fromDate" style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #495057; font-size: 0.9rem; text-transform: uppercase; letter-spacing: 0.5px;">üìÖ Data Inizio</label>
            <input type="date" id="fromDate" required style="width: 100%; padding: 0.75rem; border: 2px solid #e9ecef; border-radius: 6px; font-size: 1rem; transition: all 0.3s ease; background: white;">
          </div>
          <div>
            <label for="toDate" style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #495057; font-size: 0.9rem; text-transform: uppercase; letter-spacing: 0.5px;">üìÖ Data Fine</label>
            <input type="date" id="toDate" required style="width: 100%; padding: 0.75rem; border: 2px solid #e9ecef; border-radius: 6px; font-size: 1rem; transition: all 0.3s ease; background: white;">
          </div>
        </div>
        <div style="display: flex; flex-direction: column; align-items: stretch; gap: 0.5rem; margin-bottom: 1rem;">
          <label for="excelFile" style="margin-bottom: 0; font-weight: 600; color: #495057; font-size: 0.9rem; text-transform: uppercase; letter-spacing: 0.5px; min-width: 120px;">üìÑ Importa ore da Excel</label>
          <input type="file" id="excelFile" name="excelFile" accept=".xlsx,.xls" style="padding: 0.5rem; border: 2px solid #e9ecef; border-radius: 6px; font-size: 1rem; background: white;">
          <button id="importExcelBtn" class="btn btn-success" type="button" style="white-space:nowrap; min-width:170px; align-self: flex-start;"><span>‚¨ÜÔ∏è</span> Importa Ore da Excel</button>
        </div>
        <div id="importExcelMsg" style="margin-bottom:1rem;font-size:1rem;font-weight:600;min-height:24px;"></div>
        <div class="btn-grid" style="display: grid; grid-template-columns: 1fr; gap: 1rem;">
          <button id="listProjectsBtn" class="btn btn-secondary" type="button"><span>üìã</span> Recupera Lista Progetti</button>
          <button id="processSelectedBtn" class="btn btn-success" disabled><span>‚ö°</span> Elabora Selezionati (<span id="selectedCount">0</span>)</button>
        </div>
      </form>
    </aside>
    <!-- Main content: stats + tabella -->
    <main style="flex: 1 1 0; min-width: 0;">
      <div class="header">
        <h1>üöÄ Project integration Manager</h1>
        <p>importazione  Progetti e Ore su QuickBooks</p>
        <div id="token-status" class="token-status">Verifica token in corso...</div>
      </div>
      <!-- Stats e tabella subito sotto header, senza margini -->
      <div class="stats" style="margin-top:0;">
        <div class="stats-item">
          <div class="stats-number" id="totalProjects">0</div>
          <div class="stats-label">Progetti Totali</div>
        </div>
        <div class="stats-item">
          <div class="stats-number" id="selectedProjects">0</div>
          <div class="stats-label">Selezionati</div>
        </div>
        <div class="stats-item">
          <div class="stats-number" id="activeProjects">0</div>
          <div class="stats-label">Attivi</div>
        </div>
      </div>
      <div class="table-container" style="height: 700px; margin-top:0;">
        <table id="projectList">
          <thead>
            <tr>
              <th><input type="checkbox" id="selectAll" title="Seleziona tutti"></th>
              <th>Codice</th>
              <th>Numero</th>
              <th>Nome Progetto</th>
              <th>Stato</th>
              <th>Responsabile</th>
              <th>Valore</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td colspan="6" style="text-align: center; color: #6c757d; font-style: italic; padding: 3rem;">
                üìä Clicca "Recupera Progetti" per iniziare
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </main>
  </div>

  <!-- Aggiungi modale per payload progetto -->
  <div id="projectModal" style="display:none;position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.5);z-index:9999;align-items:center;justify-content:center;">
    <div style="background:#fff;max-width:800px;width:90vw;max-height:90vh;overflow:auto;padding:2em 1.5em 1.5em 1.5em;border-radius:10px;position:relative;">
      <button id="closeProjectModal" style="position:absolute;top:10px;right:10px;font-size:1.2em;">&times;</button>
      <h3 style="margin-top:0">Dettaglio Progetto</h3>
      <pre id="projectPayload" style="background:#222;color:#0f0;padding:1em;overflow:auto;font-size:0.95em;"></pre>
    </div>
  </div>

  <!-- Modale verifica importazione Excel -->
  <div id="excelImportModal" style="display:none;position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.7);z-index:9999;align-items:center;justify-content:center;padding:2rem;"></div>

  <div id="excelImportResult" style="margin:2rem 0 0 0;"></div>

  <script src="/static/js/token-status.js"></script>
  <script>
    // Imposta data odierna
    function setDefaultDates() {
      const today = new Date();
      const todayString = today.toISOString().split('T')[0];
      document.getElementById("fromDate").value = todayString;
      document.getElementById("toDate").value = todayString;
    }

    // Funzioni utility
    function getStatusBadge(status) {
      const badges = {
        'Confermato': 'badge-success',
        'In location': 'badge-info',
        'Pronto': 'badge-warning',
        'Rientrato': 'badge-secondary',
        'Annullato': 'badge-secondary',
        'Concept': 'badge-warning',
        'In opzione': 'badge-info'
      };
      
      const badgeClass = badges[status] || 'badge-secondary';
      return '<span class="badge ' + badgeClass + '">' + (status || 'N/A') + '</span>';
    }
    
    function updateStats(total, selected, active) {
      document.getElementById('totalProjects').textContent = total || 0;
      document.getElementById('selectedProjects').textContent = selected || 0;
      document.getElementById('activeProjects').textContent = active || 0;
    }

    function updateSelectedCount() {
      const checkboxes = document.querySelectorAll('.project-checkbox:checked');
      const count = checkboxes.length;
      document.getElementById('selectedCount').textContent = count;
      document.getElementById('processSelectedBtn').disabled = count === 0;
      
      const totalProjects = parseInt(document.getElementById('totalProjects').textContent) || 0;
      const activeProjects = parseInt(document.getElementById('activeProjects').textContent) || 0;
      updateStats(totalProjects, count, activeProjects);
    }
    
    function attachCheckboxEvents() {
      document.querySelectorAll('.project-checkbox').forEach(function(checkbox) {
        checkbox.addEventListener('change', function() {
          const row = this.closest('tr');
          if (this.checked) {
            row.classList.add('selected-row');
          } else {
            row.classList.remove('selected-row');
          }
          updateSelectedCount();
        });
      });
    }

    // Utility per recuperare dettagli progetto da Rentman
    async function getProjectDetails(projectId) {
      try {
        const resp = await fetch('/dettaglio-progetto/' + encodeURIComponent(projectId));
        if (!resp.ok) return {};
        const data = await resp.json();
        return {
          subcustomer_name: (data && data.project && data.project.name) ? data.project.name : '',
          project_number: (data && data.project && data.project.number) ? data.project.number : '',
          project_end: (data && data.project && data.project.equipment_period_to) ? data.project.equipment_period_to : ''
        };
      } catch (e) {
        return {};
      }
    }

    // Mostra la tabella di verifica in una modale, con colonne aggiuntive
    async function renderExcelImportModal(report) {
      // Recupera dettagli progetto per ogni riga (solo se non gi√† presenti)
      for (const r of report) {
        if (!r.subcustomer_name || !r.project_number || !r.project_end) {
          const details = await getProjectDetails(r.project_id);
          r.subcustomer_name = details.subcustomer_name || r.subcustomer_name;
          r.project_number = details.project_number || '';
          r.project_end = details.project_end || '';
        }
      }
      let html = '<div style="background:#fff;max-width:900px;width:98vw;max-height:90vh;overflow:auto;padding:2em 1.5em 1.5em 1.5em;border-radius:10px;position:relative;">';
      html += '<button id="closeExcelImportModal" style="position:absolute;top:10px;right:10px;font-size:1.2em;">&times;</button>';
      html += '<h3 style="margin-top:0">Verifica dati importati da Excel</h3>';
      html += '<table style="width:100%;margin-top:1rem;border-collapse:collapse;">';
      html += '<thead><tr style="background:#f8f9fa;"><th>Project ID</th><th>Numero Progetto</th><th>Fine Progetto</th><th>Sub-customer</th><th>Dipendente</th><th>Ore</th><th>Esito</th><th>Messaggio</th></tr></thead><tbody>';
      for (const r of report) {
        html += `<tr style="border-bottom:1px solid #e9ecef;">
          <td>${r.project_id || ''}</td>
          <td>${r.project_number || ''}</td>
          <td>${r.project_end || ''}</td>
          <td>${r.subcustomer_name || ''}</td>
          <td>${r.employee_name || ''}</td>
          <td>${r.ore || ''}</td>
          <td style="color:${r.esito==='OK'?'#27ae60':'#e74c3c'};font-weight:600;">${r.esito}</td>
          <td>${r.esito==='OK'?'':(r.esito||'')}</td>
        </tr>`;
      }
      html += '</tbody></table>';
      html += '<div style="margin-top:2em;text-align:right;">';
      html += '<button id="closeExcelImportModalBtn" class="btn btn-secondary" style="margin-right:1em;">Chiudi</button>';
      html += '<button id="openTransferModalBtn" class="btn btn-primary">‚¨ÜÔ∏è Trasferisci su QuickBooks</button>';
      html += '</div></div>';
      const modal = document.getElementById('excelImportModal');
      modal.innerHTML = html;
      modal.style.display = 'flex';
      document.getElementById('closeExcelImportModal').onclick = function() {
        modal.style.display = 'none';
      };
      document.getElementById('closeExcelImportModalBtn').onclick = function() {
        modal.style.display = 'none';
      };
      document.getElementById('openTransferModalBtn').onclick = function() {
        openTransferModal();
      };
    }

    // Modale di conferma trasferimento
    function openTransferModal() {
      const okRows = lastExcelImportReport.filter(r => r.esito === 'OK');
      if (okRows.length === 0) {
        alert('Nessuna riga valida da trasferire su QuickBooks.');
        return;
      }
      let modalHtml = '<div id="transferModalOverlay" style="position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.5);z-index:9999;display:flex;align-items:center;justify-content:center;">';
      modalHtml += '<div style="background:#fff;max-width:700px;width:90vw;max-height:90vh;overflow:auto;padding:2em 1.5em 1.5em 1.5em;border-radius:10px;position:relative;">';
      modalHtml += '<h3 style="margin-top:0">Conferma trasferimento ore su QuickBooks</h3>';
      modalHtml += '<p>Vuoi trasferire le seguenti righe su QuickBooks?</p>';
      modalHtml += '<table style="width:100%;margin-top:1rem;border-collapse:collapse;font-size:0.95em;">';
      modalHtml += '<thead><tr style="background:#f8f9fa;"><th>Project ID</th><th>Dipendente</th><th>Ore</th></tr></thead><tbody>';
      for (const r of okRows) {
        // Mostra ore e minuti in formato HH:MM
        let oreStr = (typeof r.hours !== 'undefined' && typeof r.minutes !== 'undefined')
          ? `${r.hours}:${r.minutes.toString().padStart(2, '0')}`
          : (r.ore || '');
        modalHtml += `<tr><td>${r.project_id}</td><td>${r.employee_name}</td><td>${oreStr}</td></tr>`;
      }
      modalHtml += '</tbody></table>';
      modalHtml += '<div style="margin-top:2em;text-align:right;">';
      modalHtml += '<button id="cancelTransferBtn" class="btn btn-secondary" style="margin-right:1em;">Annulla</button>';
      modalHtml += '<button id="confirmTransferBtn" class="btn btn-primary">OK, trasferisci</button>';
      modalHtml += '</div></div></div>';
      let modalDiv = document.createElement('div');
      modalDiv.innerHTML = modalHtml;
      document.body.appendChild(modalDiv);
      document.getElementById('cancelTransferBtn').onclick = function() {
        document.body.removeChild(modalDiv);
      };
      document.getElementById('transferModalOverlay').onclick = function(e) {
        if (e.target === this) document.body.removeChild(modalDiv);
      };
      document.getElementById('confirmTransferBtn').onclick = function() {
        document.body.removeChild(modalDiv);
        transferExcelRowsToQb();
      };
    }

    // Dopo trasferimento, aggiorna la tabella con i nomi sub-customer
    function transferExcelRowsToQb() {
      const okRows = lastExcelImportReport.filter(r => r.esito === 'OK');
      if (okRows.length === 0) {
        alert('Nessuna riga valida da trasferire su QuickBooks.');
        return;
      }
      const btn = document.getElementById('transferToQbBtn') || document.getElementById('openTransferModalBtn');
      const originalText = btn.innerHTML;
      btn.disabled = true;
      btn.innerHTML = '‚è≥ Trasferimento in corso...';
      fetch('/trasferisci-ore-qb', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ rows: okRows })
      })
      .then(r => r.json())
      .then(js => {
        btn.disabled = false;
        btn.innerHTML = originalText;
        if (js.success) {
          // Aggiorna la modale con i risultati e i nomi sub-customer
          lastExcelImportReport = js.report;
          renderExcelImportModal(js.report);
          alert('‚úÖ Trasferimento completato!');
        } else {
          alert('‚ùå Errore trasferimento: ' + (js.error || js.message || 'Errore sconosciuto'));
        }
      })
      .catch(err => {
        btn.disabled = false;
        btn.innerHTML = originalText;
        alert('‚ùå Errore: ' + err);
      });
    }
    // Event Listeners
    document.addEventListener('DOMContentLoaded', function() {
      setDefaultDates();
      
      // Form importazione ORE
      document.getElementById("importForm").addEventListener("submit", function(e) {
        e.preventDefault();
        const from = document.getElementById("fromDate").value;
        const to = document.getElementById("toDate").value;
        
        if (!from || !to) {
          alert('‚ùå Seleziona le date');
          return;
        }
        
        // Chiedi il nome dell'employee per le ore
        const employeeName = prompt('üë§ Inserisci il nome dell employee per le ore:', 'GINUDDO');
        if (!employeeName) {
          alert('‚ùå Nome employee richiesto per importare le ore');
          return;
        }
        
        const confirmed = confirm('üïê Importare ore per tutti i progetti dal ' + from + ' al ' + to + '?\n\nüë§ Employee: ' + employeeName + '\n\n‚ö†Ô∏è L operazione potrebbe richiedere diversi minuti.');
        if (!confirmed) return;
        
        // Disabilita il pulsante durante l'importazione
        const btn = e.target.querySelector('button[type="submit"]');
        const originalText = btn.innerHTML;
        btn.disabled = true;
        btn.innerHTML = '<span>‚è≥</span> Importazione in corso...';
        
        fetch("/avvia-importazione", {
          method: "POST",
          headers: {"Content-Type": "application/json"},
          body: JSON.stringify({ fromDate: from, toDate: to, employeeName: employeeName })
        })
        .then(function(r) { return r.json(); })
        .then(function(js) {
          // Riabilita il pulsante
          btn.disabled = false;
          btn.innerHTML = originalText;
          
          if (js.success) {
            alert('‚úÖ ' + (js.message || "Importazione ore completata con successo"));
          } else {
            alert('‚ùå Errore importazione ore: ' + (js.error || js.message || 'Errore sconosciuto'));
          }
          
          // Log dettagliato
          if (js.output) {
            console.log('üìÑ Output importazione ore:', js.output);
          }
        })
        .catch(function(err) {
          // Riabilita il pulsante
          btn.disabled = false;
          btn.innerHTML = originalText;
          alert('‚ùå Errore: ' + err);
        });
      });

      // Lista progetti
      document.getElementById("listProjectsBtn").addEventListener("click", function() {
        console.log("üöÄ INIZIO - Pulsante cliccato");
        
        const from = document.getElementById("fromDate").value;
        const to = document.getElementById("toDate").value;
        const tbody = document.querySelector("#projectList tbody");
        
        console.log("üìÖ Date selezionate:", { from: from, to: to });
        
        if (!from || !to) {
          console.log("‚ùå Date mancanti");
          alert('‚ùå Seleziona le date per recuperare i progetti');
          return;
        }
        
        console.log("‚è≥ Inizio caricamento...");
        tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 3rem;">‚è≥ Caricamento...</td></tr>';
        
        console.log("üåê Invio richiesta al server...");
        fetch("/lista-progetti", {
          method: "POST",
          headers: {"Content-Type": "application/json"},
          body: JSON.stringify({ fromDate: from, toDate: to })
        })
        .then(function(r) {
          console.log("üì° Risposta ricevuta, status:", r.status);
          return r.json();
        })
        .then(function(js) {
          console.log("üì• RICEVUTO DAL SERVER - Risposta completa:", js);
          
          // üîç DEBUG: Stampa i primi progetti ricevuti
          if (js.projects && js.projects.length > 0) {
            console.log("üì• RICEVUTO DAL SERVER - Debug primi 3 progetti:");
            js.projects.slice(0, 3).forEach(function(p, i) {
              console.log('  Progetto ' + (i+1) + ':');
              console.log('    ID: ' + p.id + ' (tipo: ' + typeof p.id + ')');
              console.log('    NUMBER: ' + p.number + ' (tipo: ' + typeof p.number + ')');
              console.log('    NAME: ' + p.name + ' (tipo: ' + typeof p.name + ')');
              console.log('    STATUS: ' + p.status + ' (tipo: ' + typeof p.status + ')');
              console.log('    Oggetto completo:', p);
            });
          } else {
            console.log("‚ö†Ô∏è Nessun progetto nell'array o array vuoto");
          }
          
          if (js.error) {
            console.log("‚ùå Errore dal server:", js.error);
            tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; color: #dc3545; padding: 3rem;">‚ö†Ô∏è Errore nel caricamento</td></tr>';
            alert('‚ùå Errore: ' + js.error);
            return;
          }
          
          if (!js.projects || js.projects.length === 0) {
            console.log("üìã Nessun progetto trovato");
            tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; color: #6c757d; padding: 3rem;">üìã Nessun progetto trovato</td></tr>';
            updateStats(0, 0, 0);
            return;
          }
          
          console.log("üî® INIZIO RENDERING di", js.projects.length, "progetti");
          tbody.innerHTML = "";
          let activeCount = 0;
          
          console.log("üî® CREAZIONE RIGHE - Debug rendering:");
          js.projects.forEach(function(p, index) {
            // üîç DEBUG: Per ogni progetto durante il rendering
            if (index < 3) {
              console.log('  üî® Rendering progetto ' + (index + 1) + ':');
              console.log('    p.id: ' + p.id);
              console.log('    p.number: ' + p.number);
              console.log('    p.number || "N/A": ' + (p.number || 'N/A'));
              console.log('    Condizione (p.number || "N/A"): ' + (p.number || 'N/A'));
            }
            
            if (p.status && !['Annullato', 'Rientrato'].includes(p.status)) {
              activeCount++;
            }
            
            const statusBadge = getStatusBadge(p.status);
            const tr = document.createElement("tr");
            
            // üîç DEBUG: Valore finale che finisce nell'HTML
            const finalNumber = p.number || 'N/A';
            if (index < 3) {
              console.log('    üíª Valore finale nell HTML: "' + finalNumber + '"');
            }
            
            tr.innerHTML = '<td><input type="checkbox" class="project-checkbox" data-project-id="' + p.id + '" data-project-name="' + p.name + '"></td>' +
              '<td><strong>' + (p.id || 'N/A') + '</strong></td>' +
              '<td><code>' + finalNumber + '</code></td>' +
              '<td style="max-width: 300px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="' + (p.name || 'N/A') + '">' +
                '<a href="#" class="project-link" data-project-id="' + p.id + '">' + (p.name || 'N/A') + '</a>' +
                ((p.equipment_period_from && p.equipment_period_to) ?
                  '<br><span style="font-size: 0.8em; color: #888; font-style: italic;">' +
                    p.equipment_period_from + ' ‚Üí ' + p.equipment_period_to +
                  '</span>' :
                  '') +
                (p.project_type_name ?
                  '<br><span style="font-size: 0.8em; color: #888; font-style: italic;">' +
                    p.project_type_name +
                  '</span>' :
                  '') +
              '</td>' +
              '<td>' + statusBadge + '</td>' +
              '<td>' + (
                (p.manager_name ?
                  '<strong>' + p.manager_name + '</strong>' +
                  (p.manager_email ? '<br><span style="font-size:0.85em;color:#555;">' + p.manager_email + '</span>' : '')
                : 'N/A')
              ) + '</td>' +
              '<td style="text-align: right;">' + (p.project_value && p.project_value !== '0.00' ? ('‚Ç¨ ' + p.project_value) : 'N/A') + '</td>';
            tbody.appendChild(tr);
          });
          
          // üîó Collegamento eventi checkbox...
          attachCheckboxEvents();
          
          // üîó Collegamento eventi click sui link progetto per modale payload
          document.querySelectorAll('.project-link').forEach(function(link) {
            link.addEventListener('click', function(e) {
              e.preventDefault();
              const projectId = this.dataset.projectId;
              const modal = document.getElementById('projectModal');
              const pre = document.getElementById('projectPayload');
              pre.textContent = 'Caricamento...';
              modal.style.display = 'flex';
              fetch('/dettaglio-progetto/' + encodeURIComponent(projectId))
                .then(r => r.json())
                .then(data => {
                  pre.textContent = JSON.stringify(data, null, 2);
                })
                .catch(err => {
                  pre.textContent = 'Errore nel caricamento del payload: ' + err;
                });
            });
          });
          // Gestione chiusura modale
          document.getElementById('closeProjectModal').onclick = function() {
            document.getElementById('projectModal').style.display = 'none';
          };
          // Chiudi modale cliccando fuori dal contenuto
          document.getElementById('projectModal').addEventListener('click', function(e) {
            if (e.target === this) this.style.display = 'none';
          });

          console.log("üìä Aggiornamento statistiche...");
          updateStats(js.projects.length, 0, activeCount);
          
          console.log("‚úÖ COMPLETATO rendering di", js.projects.length, "progetti");
        })
        .catch(function(err) {
          console.error("üí• ERRORE nella richiesta:", err);
          tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; color: #dc3545; padding: 3rem;">üîå Errore connessione</td></tr>';
          alert('‚ùå Errore di connessione');
        });
      });

      // Seleziona tutti
      document.getElementById('selectAll').addEventListener('change', function() {
        const checkboxes = document.querySelectorAll('.project-checkbox');
        const rows = document.querySelectorAll('#projectList tbody tr');
        
        checkboxes.forEach(function(checkbox, index) {
          checkbox.checked = this.checked;
          if (this.checked) {
            rows[index].classList.add('selected-row');
          } else {
            rows[index].classList.remove('selected-row');
          }
        }.bind(this));
        updateSelectedCount();
      });

      // Elabora selezionati (SOLO FATTURE)
      document.getElementById('processSelectedBtn').addEventListener('click', function() {
        const selectedCheckboxes = document.querySelectorAll('.project-checkbox:checked');
        const selectedProjects = Array.from(selectedCheckboxes).map(function(checkbox) {
          return {
            id: checkbox.dataset.projectId,
            name: checkbox.dataset.projectName
          };
        });
        
        if (selectedProjects.length === 0) {
          alert('‚ö†Ô∏è Nessun progetto selezionato!');
          return;
        }
        
        const projectList = selectedProjects.map(function(p) {
          return '‚Ä¢ ' + p.name + ' (ID: ' + p.id + ')';
        }).join('\n');
        
        const confirmed = confirm('üí∞ Elaborare FATTURE per ' + selectedProjects.length + ' progetti selezionati?\n\n' + projectList + '\n\nüìù Nota: Questa operazione crea solo Customer/Sub-customer e Fatture.\nPer importare le ore, usa "Avvia Importazione Ore".\n\n‚ö†Ô∏è L operazione potrebbe richiedere diversi minuti.');
        
        if (confirmed) {
          // Disabilita il pulsante durante l'elaborazione
          const btn = document.getElementById('processSelectedBtn');
          const originalText = btn.innerHTML;
          btn.disabled = true;
          btn.innerHTML = '<span>‚è≥</span> Elaborazione fatture...';
          
          console.log('üí∞ Invio richiesta elaborazione fatture:', selectedProjects);
          
          fetch('/elabora-selezionati', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
              selectedProjects: selectedProjects
            })
          })
          .then(function(r) { return r.json(); })
          .then(function(response) {
            console.log('üì• Risposta elaborazione fatture:', response);
            
            // Riabilita il pulsante
            btn.disabled = false;
            btn.innerHTML = originalText;
            
            if (response.success) {
              // Mostra risultati dettagliati
              const summary = response.summary;
              let message = '‚úÖ Elaborazione fatture completata!\n\n';
              message += 'üìä Risultati:\n';
              message += '   ‚Ä¢ Totali: ' + summary.total + '\n';
              message += '   ‚Ä¢ Successi: ' + summary.success + '\n';
              
              // Mostra anche il numero di operazioni simulate se presenti
              if (summary.simulated && summary.simulated > 0) {
                message += '   ‚Ä¢ Simulati: ' + summary.simulated + ' (token scaduto)\n';
              }
              
              message += '   ‚Ä¢ Errori: ' + summary.errors + '\n';
              message += '   ‚Ä¢ Timeout: ' + summary.timeouts + '\n\n';
              
              if (summary.simulated && summary.simulated > 0) {
                message += '‚ö†Ô∏è ATTENZIONE: Alcune fatture sono state simulate perch√© il token QuickBooks √® scaduto.\n';
                message += 'Per creare le fatture reali, aggiorna il token seguendo le istruzioni in AGGIORNAMENTO_TOKEN_QUICKBOOKS.md.\n\n';
              }
              
              if (summary.errors > 0 || summary.timeouts > 0) {
                message += '‚ö†Ô∏è Controlla la console del server per dettagli sugli errori.\n\n';
              }
              
              message += 'üí° Per importare le ore, usa "Avvia Importazione Ore"';
              
              alert(message);
              
              // Log dettagliato in console
              console.log('üìã Risultati dettagliati per progetto:');
              response.results.forEach(function(result, index) {
                let statusText = result.status.toUpperCase();
                
                // Aggiungi indicatore per operazioni simulate
                if (result.status === 'success_simulated') {
                  statusText = 'SIMULATO';
                }
                
                console.log('  ' + (index + 1) + '. ' + result.project_name + ' (' + result.project_id + '): ' + statusText);
                if (result.message) {
                  console.log('     ‚ÑπÔ∏è ' + result.message);
                }
                if (result.error) {
                  console.error('     ‚ùå Errore: ' + result.error);
                }
              });
            } else {
              alert('‚ùå Errore durante l elaborazione fatture: ' + (response.error || 'Errore sconosciuto'));
            }
          })
          .catch(function(err) {
            console.error('üí• Errore nella richiesta:', err);
            // Riabilita il pulsante
            btn.disabled = false;
            btn.innerHTML = originalText;
            alert('‚ùå Errore di connessione durante l elaborazione fatture');
          });
        }
      });
      
      // Importazione ore da Excel
      document.getElementById('importExcelBtn').addEventListener('click', function() {
        const fileInput = document.getElementById('excelFile');
        const file = fileInput.files[0];
        const msgDiv = document.getElementById('importExcelMsg');
        msgDiv.textContent = '';
        msgDiv.style.color = '';
        if (!file) {
          msgDiv.textContent = '‚ùå Seleziona un file Excel da importare';
          msgDiv.style.color = '#e74c3c';
          return;
        }
        const dataAttivita = document.getElementById('toDate').value;
        if (!dataAttivita) {
          msgDiv.textContent = '‚ùå Data attivit√† obbligatoria';
          msgDiv.style.color = '#e74c3c';
          return;
        }
        const btn = document.getElementById('importExcelBtn');
        const originalText = btn.innerHTML;
        btn.disabled = true;
        btn.innerHTML = '<span>‚è≥</span> Importazione in corso...';
        const formData = new FormData();
        formData.append('excelFile', file);
        formData.append('data_attivita', dataAttivita);
        fetch('/importa-ore-excel', {
          method: 'POST',
          body: formData
        })
        .then(r => r.json())
        .then(js => {
          btn.disabled = false;
          btn.innerHTML = originalText;
          if (js.success) {
            msgDiv.textContent = '‚úÖ Importazione completata: ' + js.message;
            msgDiv.style.color = '#27ae60';
          } else {
            msgDiv.textContent = '‚ùå Errore importazione: ' + (js.error || js.message || 'Errore sconosciuto');
            msgDiv.style.color = '#e74c3c';
          }
        })
        .catch(err => {
          btn.disabled = false;
          btn.innerHTML = originalText;
          msgDiv.textContent = '‚ùå Errore: ' + err;
          msgDiv.style.color = '#e74c3c';
        });
      });
    });
  </script>
</body>
</html>
