<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Rentman Project Manager</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg: #f5f6fb;
      --bg-soft: #eef1f7;
      --panel: #ffffff;
      --card: #ffffff;
      --border: #d8deea;
      --text: #1f2937;
      --muted: #6b7280;
      --primary: #2563eb;
      --primary-2: #1d4ed8;
      --success: #16a34a;
      --warning: #d97706;
      --danger: #dc2626;
      --info: #0ea5e9;
      --radius: 14px;
      --shadow: 0 15px 45px rgba(31,41,55,0.14);
      --shadow-soft: 0 10px 28px rgba(31,41,55,0.12);
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body { 
      font-family: 'Manrope', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: radial-gradient(circle at 20% 20%, rgba(37,99,235,0.12), transparent 30%),
                  radial-gradient(circle at 80% 0%, rgba(14,165,233,0.1), transparent 28%),
                  linear-gradient(135deg, #f7f9fd 0%, #eef1f7 100%);
      color: var(--text);
      min-height: 100vh;
      padding: 1.25rem;
    }

    body.auth-blocked {
      overflow: hidden;
    }
    
    .container { 
      display: flex;
      flex-direction: row;
      gap: 1.25rem;
      max-width: 1600px;
      margin: 0 auto;
      align-items: flex-start;
    }
    
    .header {
      background: linear-gradient(120deg, #2563eb, #0ea5e9);
      color: white;
      padding: 1.05rem 1.35rem;
      margin-bottom: 0.6rem;
      width: 100%;
      border-radius: var(--radius);
      box-shadow: var(--shadow);
    }

    .header-inner {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 1rem;
      flex-wrap: wrap;
    }
    
    .header h1 {
      font-size: 1.65rem;
      font-weight: 700;
      margin-bottom: 0.15rem;
      letter-spacing: -0.01em;
    }
    
    .header p {
      opacity: 0.9;
      font-size: 0.95rem;
      font-weight: 500;
      letter-spacing: 0.01em;
    }
    
    .token-status {
      margin-top: 0;
      padding: 10px 16px;
      border-radius: 999px;
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      font-size: 0.9rem;
      font-weight: 700;
      letter-spacing: 0.2px;
      background: rgba(255,255,255,0.2);
      color: #fff;
      border: 1px solid rgba(255,255,255,0.35);
    }
    
    .token-valid {
      background-color: #27ae60;
    }
    
    .token-invalid {
      background-color: #e67e22;
    }
    
    .token-error {
      background-color: #e74c3c;
    }
    
    .content {
      padding: 0.1rem 0 0.2rem 0;
      flex: 1 1 0;
      min-width: 0;
    }
    
    .btn {
      padding: 0.65rem 1rem;
      border: none; 
      border-radius: 10px; 
      font-weight: 700; 
      font-size: 0.95rem;
      cursor: pointer;
      transition: all 0.25s ease;
      text-transform: none;
      letter-spacing: 0.2px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
      width: 100%;
      min-height: 46px;
    }
    
    .btn-primary {
      background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
      color: white;
      box-shadow: 0 6px 18px rgba(37, 99, 235, 0.28);
    }
    
    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
    }
    
    .btn-secondary {
      background: linear-gradient(135deg, #0ea5e9 0%, #06b6d4 100%);
      color: white;
      box-shadow: 0 6px 18px rgba(6, 182, 212, 0.26);
    }

    .btn-info {
      background: linear-gradient(135deg, #0284c7 0%, #0ea5e9 100%);
      color: white;
      box-shadow: 0 6px 18px rgba(14, 165, 233, 0.26);
    }

    .btn-warning {
      background: linear-gradient(135deg, #f59e0b 0%, #f97316 100%);
      color: #111827;
      box-shadow: 0 6px 18px rgba(249, 115, 22, 0.24);
    }
    
    .btn-secondary:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(33, 150, 243, 0.4);
    }
    
    .btn-success {
      background: linear-gradient(135deg, #16a34a 0%, #15803d 100%);
      color: white;
      box-shadow: 0 6px 18px rgba(22, 163, 74, 0.24);
    }
    
    .btn-success:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(40, 167, 69, 0.4);
    }
    
    .btn-danger {
      background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
      color: white;
      box-shadow: 0 6px 18px rgba(220, 38, 38, 0.24);
    }
    
    .btn-danger:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(231, 76, 60, 0.4);
    }
    
    .btn:disabled {
      background: #cbd5e1;
      cursor: not-allowed;
      transform: none !important;
      box-shadow: none !important;
      color: #475569;
    }
    
    .stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
      gap: 0.75rem;
      margin-bottom: 0.75rem;
    }
    
    .stats-card {
      background: #ffffff;
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 0.9rem 1rem;
      box-shadow: var(--shadow-soft);
      display: flex;
      flex-direction: column;
      gap: 0.25rem;
    }
    
    .stats-item {
      text-align: center;
    }
    
    .stats-number {
      font-size: 1.6rem;
      font-weight: 800;
      color: #0f172a;
    }
    
    .stats-label {
      font-size: 0.85rem;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: 0.6px;
      font-weight: 600;
    }
    
    .table-container { 
      height: 700px; 
      overflow-y: auto; 
      border: 1px solid var(--border);
      border-radius: var(--radius);
      background: #ffffff;
      margin-top: 0.2rem;
      box-shadow: var(--shadow-soft);
    }
    
    table { 
      width: 100%; 
      border-collapse: separate; 
      border-spacing: 0; 
      font-size: 0.9rem; 
      color: var(--text);
    }

    th, td { 
      padding: 0.65rem 0.5rem;
      text-align: left; 
      border-bottom: 1px solid var(--border);
    }

    th { 
      background: linear-gradient(180deg, #f8fafc, #eef2f7);
      font-weight: 700;
      color: #1f2937;
      position: sticky; 
      top: 0; 
      z-index: 10;
      text-transform: uppercase;
      font-size: 0.78rem;
      letter-spacing: 0.55px;
      backdrop-filter: blur(8px);
    }

    tbody tr {
      transition: all 0.2s ease;
    }

    tbody tr:hover { 
      background: #f8fafc;
    }
    
    input[type="checkbox"] {
      width: 18px;
      height: 18px;
      margin: 0;
      cursor: pointer;
      accent-color: var(--primary);
    }
    
    th:first-child, td:first-child {
      width: 50px;
      text-align: center;
    }
    
    .selected-row {
      background: linear-gradient(135deg, rgba(37,99,235,0.12) 0%, rgba(14,165,233,0.1) 100%) !important;
      border-left: 4px solid var(--primary);
    }
    
    .badge {
      display: inline-block;
      padding: 0.25rem 0.75rem;
      font-size: 0.75rem;
      font-weight: 600;
      border-radius: 12px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .badge-success { background: rgba(22,163,74,0.12); color: #166534; }
    .badge-warning { background: rgba(217,119,6,0.12); color: #92400e; }
    .badge-info { background: rgba(14,165,233,0.12); color: #0f4b6e; }
    .badge-secondary { background: rgba(31,41,55,0.08); color: #1f2937; }
    
    @media (max-width: 768px) {
      body {
        padding: 0.2rem;
      }
      
      .header h1 {
        font-size: 1.5rem;
      }
      
      .config-section {
        padding: 1.5rem;
      }
      
      .config-grid {
        grid-template-columns: 1fr !important;
      }
      
      .btn-grid {
        grid-template-columns: 1fr !important;
      }
      
      .sidebar-config {
        padding: 0.5rem 0.3rem;
        height: auto;
        min-height: unset;
      }
      
      .header {
        padding: 0.1rem 0.5rem 0.1rem 0.5rem;
      }
    }
    
    /* Sidebar configurazione: tutta altezza viewport */
    .sidebar-config {
      width: 340px;
      min-width: 280px;
      max-width: 380px;
      background: var(--panel);
      border-radius: var(--radius);
      border: 1px solid var(--border);
      box-shadow: var(--shadow);
      padding: 1.1rem 1rem;
      position: sticky;
      top: 1rem;
      height: calc(100vh - 2rem);
      align-self: stretch;
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }

    .section-title {
      color: #e5e7eb;
      margin-bottom: 0.5rem;
      font-weight: 700;
      font-size: 1.05rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .card-soft {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 0.85rem 0.9rem;
      box-shadow: var(--shadow-soft);
    }

    .sidebar-config label {
      color: #0f172a !important;
      font-weight: 700;
      letter-spacing: 0.3px;
    }

    .sidebar-config input,
    .sidebar-config select,
    .sidebar-config textarea {
      background: #ffffff;
      color: var(--text);
      border: 1px solid var(--border);
      border-radius: 10px;
      min-height: 42px;
      padding: 0.65rem 0.75rem;
    }

    .sidebar-config input:focus,
    .sidebar-config select:focus,
    .sidebar-config textarea:focus {
      outline: 2px solid var(--primary);
      border-color: var(--primary);
      box-shadow: 0 0 0 4px rgba(37,99,235,0.18);
    }

    /* Login overlay */
    .login-overlay {
      position: fixed;
      inset: 0;
      background: radial-gradient(circle at 20% 20%, rgba(37,99,235,0.18), transparent 32%),
                  radial-gradient(circle at 80% 10%, rgba(14,165,233,0.16), transparent 30%),
                  rgba(15,23,42,0.82);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 12000;
      padding: 1.5rem;
    }

    .login-card {
      background: #0b1220;
      color: #e5e7eb;
      width: min(420px, 95vw);
      border-radius: 14px;
      padding: 1.75rem 1.5rem;
      box-shadow: 0 22px 60px rgba(0,0,0,0.45);
      border: 1px solid rgba(255,255,255,0.08);
    }

    .login-title {
      font-size: 1.4rem;
      font-weight: 800;
      margin-bottom: 0.4rem;
      letter-spacing: -0.01em;
    }

    .login-subtitle {
      color: #cbd5e1;
      margin-bottom: 1.2rem;
      font-weight: 600;
    }

    .login-input {
      width: 100%;
      padding: 0.75rem 0.85rem;
      border-radius: 10px;
      border: 1px solid rgba(255,255,255,0.14);
      background: rgba(255,255,255,0.05);
      color: #e5e7eb;
      font-size: 1rem;
      margin-bottom: 0.75rem;
    }

    .login-input:focus {
      outline: 2px solid #60a5fa;
      border-color: #60a5fa;
      background: rgba(255,255,255,0.08);
    }

    .login-submit {
      width: 100%;
      padding: 0.75rem;
      border: none;
      border-radius: 10px;
      background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
      color: #fff;
      font-weight: 800;
      letter-spacing: 0.3px;
      cursor: pointer;
      box-shadow: 0 12px 30px rgba(37,99,235,0.35);
      transition: transform 0.2s ease, box-shadow 0.2s ease;
      margin-top: 0.35rem;
    }

    .login-submit:disabled {
      opacity: 0.7;
      cursor: not-allowed;
      box-shadow: none;
    }

    .login-submit:hover:not(:disabled) {
      transform: translateY(-1px);
      box-shadow: 0 16px 36px rgba(37,99,235,0.5);
    }

    .login-error {
      color: #fca5a5;
      font-weight: 700;
      min-height: 20px;
      margin-top: 0.35rem;
    }

    .session-info {
      display: none;
      align-items: center;
      gap: 0.5rem;
      background: rgba(255,255,255,0.2);
      color: #fff;
      border: 1px solid rgba(255,255,255,0.32);
      padding: 0.4rem 0.75rem;
      border-radius: 999px;
      font-weight: 700;
    }

    .session-info button {
      background: rgba(255,255,255,0.14);
      color: #fff;
      border: 1px solid rgba(255,255,255,0.3);
      border-radius: 999px;
      padding: 0.25rem 0.65rem;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <div id="loginOverlay" class="login-overlay">
    <div class="login-card">
      <div class="login-title">Accesso richiesto</div>
      <div class="login-subtitle">Inserisci le credenziali per continuare</div>
      <form id="loginForm" autocomplete="off">
        <input id="loginUsername" class="login-input" type="text" name="username" placeholder="Username" required>
        <input id="loginPassword" class="login-input" type="password" name="password" placeholder="Password" required>
        <button id="loginSubmit" class="login-submit" type="submit">Accedi</button>
        <div id="loginError" class="login-error"></div>
      </form>
    </div>
  </div>
  <div id="appShell" class="container" style="visibility:hidden;">
    <!-- Sidebar configurazione -->
    <aside class="sidebar-config">
      <h3 class="section-title">‚öôÔ∏è Configurazione Sistema</h3>
      <form id="importForm" enctype="multipart/form-data">
        <div class="config-grid" style="display: grid; grid-template-columns: 1fr; gap: 1rem; margin-bottom: 1.5rem;">
          <div>
            <label for="fromDate" style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #495057; font-size: 0.9rem; text-transform: uppercase; letter-spacing: 0.5px;">üìÖ Data Inizio</label>
            <input type="date" id="fromDate" required style="width: 100%; padding: 0.75rem; border: 2px solid #e9ecef; border-radius: 6px; font-size: 1rem; transition: all 0.3s ease; background: white;">
          </div>
          <div>
            <label for="toDate" style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #495057; font-size: 0.9rem; text-transform: uppercase; letter-spacing: 0.5px;">üìÖ Data Fine</label>
            <input type="date" id="toDate" required style="width: 100%; padding: 0.75rem; border: 2px solid #e9ecef; border-radius: 6px; font-size: 1rem; transition: all 0.3s ease; background: white;">
          </div>
          <div>
            <label for="projectNumber" style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #495057; font-size: 0.9rem; text-transform: uppercase; letter-spacing: 0.5px;">üîé Numero Progetto (opzionale)</label>
            <input type="text" id="projectNumber" placeholder="Inserisci numero progetto" style="width: 100%; padding: 0.75rem; border: 2px solid #e9ecef; border-radius: 6px; font-size: 1rem; transition: all 0.3s ease; background: white;">
          </div>
        </div>
        <div style="display: flex; flex-direction: column; align-items: stretch; gap: 0.5rem; margin-bottom: 1rem;">
          <label for="excelFile" style="margin-bottom: 0; font-weight: 600; color: #495057; font-size: 0.9rem; text-transform: uppercase; letter-spacing: 0.5px; min-width: 120px;">üìÑ Importa ore da Excel</label>
          <input type="file" id="excelFile" name="excelFile" accept=".xlsx,.xls" style="padding: 0.5rem; border: 2px solid #e9ecef; border-radius: 6px; font-size: 1rem; background: white;">
          <label for="excelDataAttivita" style="margin-bottom: 0; font-weight: 600; color: #495057; font-size: 0.9rem; text-transform: uppercase; letter-spacing: 0.5px; min-width: 120px;">üìÖ Data Attivit√†</label>
          <input type="date" id="excelDataAttivita" required style="width: 100%; padding: 0.75rem; border: 2px solid #e9ecef; border-radius: 6px; font-size: 1rem; transition: all 0.3s ease; background: white;">
          <button id="importExcelBtn" class="btn btn-success" type="button" style="white-space:nowrap; min-width:170px; align-self: flex-start;"><span>‚¨ÜÔ∏è</span> Importa Ore da Excel</button>
        </div>        <div id="importExcelMsg" style="margin-bottom:1rem;font-size:1rem;font-weight:600;min-height:24px;"></div>
        
        <!-- Opzioni caricamento progetti (semplificata: solo paginata) -->
        <div class="card-soft" style="margin-bottom: 1rem;">
          <label style="margin-bottom: 0.5rem; display: block;">üöÄ Modalit√† Caricamento:</label>
          <div style="display: flex; gap: 1rem; align-items: center; color: var(--text);">
            <span style="font-weight:600;color:#2196F3;">‚ö° Paginata</span>
            <select id="pageSize" style="margin-left: auto; padding: 0.25rem; opacity: 1; min-width: 120px;">
              <option value="10">10 per pagina</option>
              <option value="20" selected>20 per pagina</option>
              <option value="50">50 per pagina</option>
              <option value="100">100 per pagina</option>
            </select>
          </div>
        </div>
        
        <div class="btn-grid" style="display: grid; grid-template-columns: 1fr; gap: 0.65rem; margin-top: 0.25rem;">
          <button id="listProjectsBtn" class="btn btn-secondary" type="button">üìã Recupera Lista Progetti</button>
          <button id="processSelectedBtn" class="btn btn-success" disabled>‚ö° Elabora Selezionati (<span id="selectedCount">0</span>)</button>
          <button id="xmlToCsvBtn" class="btn btn-primary" type="button">üîÑ Converti XML in CSV</button>
          <button id="searchBillsBtn" class="btn btn-info" type="button">üîç Ricerca Fatture Database</button>
        </div>
      </form>
    </aside>
    <!-- Main content: stats + tabella -->
    <main style="flex: 1 1 0; min-width: 0;">
      <div class="header">
        <div class="header-inner">
          <div>
            <h1>Project Integration Desk</h1>
            <p>Dashboard centrale per progetti e ore QuickBooks</p>
          </div>
          <div style="display:flex;align-items:center;gap:0.5rem;flex-wrap:wrap;justify-content:flex-end;">
            <div id="token-status" class="token-status">Verifica token in corso...</div>
            <div id="sessionInfo" class="session-info">
              <span id="sessionUser">-</span>
              <button id="logoutBtn" type="button">Logout</button>
            </div>
          </div>
        </div>
      </div>
      <!-- Stats e tabella subito sotto header, senza margini -->
      <div class="stats" style="margin-top:0;">
        <div class="stats-card">
          <div class="stats-label">Progetti Totali</div>
          <div class="stats-number" id="totalProjects">0</div>
        </div>
        <div class="stats-card">
          <div class="stats-label">Selezionati</div>
          <div class="stats-number" id="selectedProjects">0</div>
        </div>
        <div class="stats-card">
          <div class="stats-label">Attivi</div>
          <div class="stats-number" id="activeProjects">0</div>
        </div>
        <div class="stats-card">
          <div class="stats-label">Tempo Caricamento</div>
          <div class="stats-number" id="loadTime">-</div>
        </div>
      </div>
      
      <!-- Barra performance -->
      <div id="performanceInfo" style="display: none; margin: 0.5rem 0; padding: 0.75rem; background: linear-gradient(135deg, #28a745, #20c997); color: white; border-radius: 8px; font-size: 0.9rem; text-align: center;">
        <span id="performanceText"></span>
      </div>
      <div class="table-container" style="height: 700px; margin-top:0;">
        <table id="projectList">
          <thead>
            <tr>
              <th><input type="checkbox" id="selectAll" title="Seleziona tutti"></th>
              <th>Codice</th>
              <th>Numero</th>
              <th>Nome Progetto</th>
              <th>Cliente</th>
              <th>Stato</th>
              <th>Responsabile</th>
              <th>Valore</th>
              <th>QB Import</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td colspan="6" style="text-align: center; color: #6c757d; font-style: italic; padding: 3rem;">
                üìä Clicca "Recupera Progetti" per iniziare
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </main>
  </div>

  <!-- Aggiungi modale per payload progetto -->
  <div id="projectModal" style="display:none;position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.5);z-index:9999;align-items:center;justify-content:center;">
    <div style="background:#fff;max-width:800px;width:90vw;max-height:90vh;overflow:auto;padding:2em 1.5em 1.5em 1.5em;border-radius:10px;position:relative;">
      <button id="closeProjectModal" style="position:absolute;top:10px;right:10px;font-size:1.2em;">&times;</button>
      <h3 style="margin-top:0">Dettaglio Progetto</h3>
      <pre id="projectPayload" style="background:#222;color:#0f0;padding:1em;overflow:auto;font-size:0.95em;"></pre>
    </div>
  </div>

  <!-- Modale verifica importazione Excel -->
  <div id="excelImportModal" style="display:none;position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.7);z-index:9999;align-items:center;justify-content:center;padding:2rem;"></div>

  <div id="excelImportResult" style="margin:2rem 0 0 0;"></div>

  <script src="/static/js/token-status.js"></script>
  <script>
    let loginState = { authenticated: false, enabled: true, user: null };
    let appInitialized = false;

    function showLoginOverlay(message) {
      const overlay = document.getElementById('loginOverlay');
      const subtitle = document.querySelector('.login-subtitle');
      if (!overlay) return;
      if (message && subtitle) subtitle.textContent = message;
      overlay.style.display = 'flex';
      document.body.classList.add('auth-blocked');
      const errorBox = document.getElementById('loginError');
      if (errorBox) errorBox.textContent = '';
      const userInput = document.getElementById('loginUsername');
      if (userInput) userInput.focus();
    }

    function hideLoginOverlay() {
      const overlay = document.getElementById('loginOverlay');
      if (overlay) overlay.style.display = 'none';
      document.body.classList.remove('auth-blocked');
      const errorBox = document.getElementById('loginError');
      if (errorBox) errorBox.textContent = '';
    }

    function showAppShell() {
      const shell = document.getElementById('appShell');
      if (shell) shell.style.visibility = 'visible';
    }

    function updateSessionInfo(userLabel) {
      const info = document.getElementById('sessionInfo');
      const userSpan = document.getElementById('sessionUser');
      if (!info || !userSpan) return;
      if (userLabel) {
        info.style.display = 'inline-flex';
        userSpan.textContent = 'üë§ ' + userLabel;
      } else {
        info.style.display = 'none';
        userSpan.textContent = '-';
      }
    }

    async function fetchAuthStatus() {
      try {
        const res = await fetch('/api/auth/status');
        const data = res.ok ? await res.json() : {};
        loginState.authenticated = !!data.authenticated;
        loginState.enabled = data.loginEnabled !== false;
        loginState.user = data.user || null;
        return loginState;
      } catch (e) {
        loginState.authenticated = false;
        return loginState;
      }
    }

    async function ensureAuthThenInit() {
      await fetchAuthStatus();
      if (!loginState.enabled) {
        hideLoginOverlay();
        updateSessionInfo('Accesso libero');
        showAppShell();
        initAppOnce();
        return;
      }
      if (loginState.authenticated) {
        hideLoginOverlay();
        updateSessionInfo(loginState.user || 'Utente');
        showAppShell();
        initAppOnce();
        return;
      }
      showLoginOverlay('Accedi per continuare');
    }

    function setupLoginUI() {
      const form = document.getElementById('loginForm');
      if (form && !form.dataset.bound) {
        form.dataset.bound = '1';
        form.addEventListener('submit', async function(e) {
          e.preventDefault();
          const usernameInput = document.getElementById('loginUsername');
          const passwordInput = document.getElementById('loginPassword');
          const submitBtn = document.getElementById('loginSubmit');
          const errorBox = document.getElementById('loginError');
          const username = (usernameInput.value || '').trim();
          const password = passwordInput.value || '';
          if (!username || !password) {
            if (errorBox) errorBox.textContent = 'Inserisci username e password';
            return;
          }
          const originalText = submitBtn ? submitBtn.innerHTML : '';
          if (submitBtn) {
            submitBtn.disabled = true;
            submitBtn.innerHTML = 'Accesso...';
          }
          try {
            const res = await fetch('/api/auth/login', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ username: username, password: password })
            });
            const data = await res.json();
            if (res.ok && data.authenticated) {
              loginState = { authenticated: true, enabled: true, user: username };
              hideLoginOverlay();
              updateSessionInfo(username);
              showAppShell();
              initAppOnce();
            } else {
              if (errorBox) errorBox.textContent = data.error || 'Credenziali non valide';
            }
          } catch (err) {
            if (errorBox) errorBox.textContent = 'Errore di connessione';
          } finally {
            if (submitBtn) {
              submitBtn.disabled = false;
              submitBtn.innerHTML = originalText || 'Accedi';
            }
          }
        });
      }

      const logoutBtn = document.getElementById('logoutBtn');
      if (logoutBtn && !logoutBtn.dataset.bound) {
        logoutBtn.dataset.bound = '1';
        logoutBtn.addEventListener('click', async function() {
          try {
            await fetch('/api/auth/logout', { method: 'POST' });
          } catch (err) {}
          loginState.authenticated = false;
          loginState.user = null;
          updateSessionInfo(null);
          const shell = document.getElementById('appShell');
          if (shell) shell.style.visibility = 'hidden';
          showLoginOverlay('Sessione terminata, accedi di nuovo');
        });
      }
    }

    // Imposta data odierna
    
    function setDefaultDates() {
      const today = new Date();
      const todayString = today.toISOString().split('T')[0];
      document.getElementById("fromDate").value = todayString;
      document.getElementById("toDate").value = todayString;
    }

    // Suggerisce modalit√† paginata per periodi lunghi
    function suggestPaginationMode() {
      const fromDate = document.getElementById("fromDate").value;
      const toDate = document.getElementById("toDate").value;
      
      if (fromDate && toDate) {
        const from = new Date(fromDate);
        const to = new Date(toDate);
        const daysDiff = Math.ceil((to - from) / (1000 * 60 * 60 * 24));
        
        // Suggerisci paginazione per periodi > 60 giorni
        if (daysDiff > 60) {
          document.getElementById('paginatedMode').checked = true;
          document.getElementById('pageSize').style.opacity = '1';
          document.getElementById('pageSize').disabled = false;
          
          // Mostra suggerimento
          showPerformanceTip(daysDiff);
        } else {
          document.getElementById('normalMode').checked = true;
          document.getElementById('pageSize').style.opacity = '0.5';
          document.getElementById('pageSize').disabled = true;
        }
      }
    }

    // Mostra suggerimento performance
    function showPerformanceTip(days) {
      const performanceInfo = document.getElementById('performanceInfo');
      const performanceText = document.getElementById('performanceText');
      
      performanceText.innerHTML = `
        üí° <strong>Suggerimento</strong>: Periodo di ${days} giorni rilevato. 
        Modalit√† <strong>Paginata</strong> selezionata automaticamente per performance ottimali.
      `;
      performanceInfo.style.background = 'linear-gradient(135deg, #17a2b8, #138496)';
      performanceInfo.style.display = 'block';
      
      // Nascondi dopo 5 secondi
      setTimeout(() => {
        if (performanceText.innerHTML.includes('Suggerimento')) {
          performanceInfo.style.display = 'none';
        }
      }, 5000);
    }

    // Funzioni utility
    function getStatusBadge(status) {
      const badges = {
        'Confermato': 'badge-success',
        'In location': 'badge-info',
        'Pronto': 'badge-warning',
        'Rientrato': 'badge-secondary',
        'Annullato': 'badge-secondary',
        'Concept': 'badge-warning',
        'In opzione': 'badge-info'
      };
      
      const badgeClass = badges[status] || 'badge-secondary';
      return '<span class="badge ' + badgeClass + '">' + (status || 'N/A') + '</span>';
    }
      function updateStats(total, selected, active, performanceData) {
      document.getElementById('totalProjects').textContent = total || 0;
      document.getElementById('selectedProjects').textContent = selected || 0;
      document.getElementById('activeProjects').textContent = active || 0;
      
      // Aggiorna tempo di caricamento
      if (performanceData && performanceData.loadTime) {
        document.getElementById('loadTime').textContent = performanceData.loadTime + 's';
      } else {
        document.getElementById('loadTime').textContent = '-';
      }
      
      // Mostra barra performance se disponibile
      if (performanceData && performanceData.speed && performanceData.projects > 0) {
        const performanceInfo = document.getElementById('performanceInfo');
        const performanceText = document.getElementById('performanceText');
        
        performanceText.innerHTML = `
          ‚ö° <strong>${performanceData.projects}</strong> progetti caricati in 
          <strong>${performanceData.loadTime}s</strong> 
          (<strong>${performanceData.speed}</strong> progetti/sec)
          ${performanceData.mode ? ' - Modalit√†: <strong>' + performanceData.mode + '</strong>' : ''}
        `;
        performanceInfo.style.display = 'block';
      } else {
        document.getElementById('performanceInfo').style.display = 'none';
      }
    }

    function updateSelectedCount() {
      const checkboxes = document.querySelectorAll('.project-checkbox:checked');
      const count = checkboxes.length;
      document.getElementById('selectedCount').textContent = count;
      document.getElementById('processSelectedBtn').disabled = count === 0;
      
      const totalProjects = parseInt(document.getElementById('totalProjects').textContent) || 0;
      const activeProjects = parseInt(document.getElementById('activeProjects').textContent) || 0;
      updateStats(totalProjects, count, activeProjects);
    }
    
    function attachCheckboxEvents() {
      document.querySelectorAll('.project-checkbox').forEach(function(checkbox) {
        checkbox.addEventListener('change', function() {
          const row = this.closest('tr');
          if (this.checked) {
            row.classList.add('selected-row');
          } else {
            row.classList.remove('selected-row');
          }
          updateSelectedCount();
        });
      });
    }

    // Utility per recuperare dettagli progetto da Rentman
    async function getProjectDetails(projectId) {
      try {
        const resp = await fetch('/dettaglio-progetto/' + encodeURIComponent(projectId));
        if (!resp.ok) return {};
        const data = await resp.json();
        return {
          subcustomer_name: (data && data.project && data.project.name) ? data.project.name : '',
          project_number: (data && data.project && data.project.number) ? data.project.number : '',
          project_end: (data && data.project && data.project.equipment_period_to) ? data.project.equipment_period_to : ''
        };
      } catch (e) {
        return {};
      }
    }

    // Mostra la tabella di verifica in una modale, con colonne aggiuntive
    async function renderExcelImportModal(report) {
      // Recupera dettagli progetto per ogni riga (solo se non gi√† presenti)
      for (const r of report) {
        if (!r.subcustomer_name || !r.project_number || !r.project_end) {
          const details = await getProjectDetails(r.project_id);
          r.subcustomer_name = details.subcustomer_name || r.subcustomer_name;
          r.project_number = details.project_number || '';
          r.project_end = details.project_end || '';
        }
      }
      let html = '<div style="background:#fff;max-width:900px;width:98vw;max-height:90vh;overflow:auto;padding:2em 1.5em 1.5em 1.5em;border-radius:10px;position:relative;">';
      html += '<button id="closeExcelImportModal" style="position:absolute;top:10px;right:10px;font-size:1.2em;">&times;</button>';
      html += '<h3 style="margin-top:0">Verifica dati importati da Excel</h3>';
      html += '<table style="width:100%;margin-top:1rem;border-collapse:collapse;">';
      html += '<thead><tr style="background:#f8f9fa;"><th>Project ID</th><th>Numero Progetto</th><th>Fine Progetto</th><th>Sub-customer</th><th>Dipendente</th><th>Ore</th><th>Esito</th><th>Messaggio</th></tr></thead><tbody>';
      for (const r of report) {
        html += `<tr style="border-bottom:1px solid #e9ecef;">
          <td>${r.project_id || ''}</td>
          <td>${r.project_number || ''}</td>
          <td>${r.project_end || ''}</td>
          <td>${r.subcustomer_name || ''}</td>
          <td>${r.employee_name || ''}</td>
          <td>${r.ore || ''}</td>
          <td style="color:${r.esito==='OK'?'#27ae60':'#e74c3c'};font-weight:600;">${r.esito}</td>
          <td>${r.esito==='OK'?'':(r.esito||'')}</td>
        </tr>`;
      }
      html += '</tbody></table>';
      html += '<div style="margin-top:2em;text-align:right;">';
      html += '<button id="closeExcelImportModalBtn" class="btn btn-secondary" style="margin-right:1em;">Chiudi</button>';
      html += '<button id="openTransferModalBtn" class="btn btn-primary">‚¨ÜÔ∏è Trasferisci su QuickBooks</button>';
      html += '</div></div>';
      const modal = document.getElementById('excelImportModal');
      modal.innerHTML = html;
      modal.style.display = 'flex';
      document.getElementById('closeExcelImportModal').onclick = function() {
        modal.style.display = 'none';
      };
      document.getElementById('closeExcelImportModalBtn').onclick = function() {
        modal.style.display = 'none';
      };
      document.getElementById('openTransferModalBtn').onclick = function() {
        openTransferModal();
      };
    }

    // Modale di conferma trasferimento
    function openTransferModal() {
      const okRows = lastExcelImportReport.filter(r => r.esito === 'OK');
      if (okRows.length === 0) {
        alert('Nessuna riga valida da trasferire su QuickBooks.');
        return;
      }
      let modalHtml = '<div id="transferModalOverlay" style="position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.5);z-index:9999;display:flex;align-items:center;justify-content:center;">';
      modalHtml += '<div style="background:#fff;max-width:700px;width:90vw;max-height:90vh;overflow:auto;padding:2em 1.5em 1.5em 1.5em;border-radius:10px;position:relative;">';
      modalHtml += '<h3 style="margin-top:0">Conferma trasferimento ore su QuickBooks</h3>';
      modalHtml += '<p>Vuoi trasferire le seguenti righe su QuickBooks?</p>';
      modalHtml += '<table style="width:100%;margin-top:1rem;border-collapse:collapse;font-size:0.95em;">';
      modalHtml += '<thead><tr style="background:#f8f9fa;"><th>Project ID</th><th>Dipendente</th><th>Ore</th></tr></thead><tbody>';
      for (const r of okRows) {
        // Mostra ore e minuti in formato HH:MM
        let oreStr = (typeof r.hours !== 'undefined' && typeof r.minutes !== 'undefined')
          ? `${r.hours}:${r.minutes.toString().padStart(2, '0')}`
          : (r.ore || '');
        modalHtml += `<tr><td>${r.project_id}</td><td>${r.employee_name}</td><td>${oreStr}</td></tr>`;
      }
      modalHtml += '</tbody></table>';
      modalHtml += '<div style="margin-top:2em;text-align:right;">';
      modalHtml += '<button id="cancelTransferBtn" class="btn btn-secondary" style="margin-right:1em;">Annulla</button>';
      modalHtml += '<button id="confirmTransferBtn" class="btn btn-primary">OK, trasferisci</button>';
      modalHtml += '</div></div></div>';
      let modalDiv = document.createElement('div');
      modalDiv.innerHTML = modalHtml;
      document.body.appendChild(modalDiv);
      document.getElementById('cancelTransferBtn').onclick = function() {
        document.body.removeChild(modalDiv);
      };
      document.getElementById('transferModalOverlay').onclick = function(e) {
        if (e.target === this) document.body.removeChild(modalDiv);
      };
      document.getElementById('confirmTransferBtn').onclick = function() {
        document.body.removeChild(modalDiv);
        transferExcelRowsToQb();
      };
    }

    // Dopo trasferimento, aggiorna la tabella con i nomi sub-customer
    function transferExcelRowsToQb() {
      const okRows = lastExcelImportReport.filter(r => r.esito === 'OK');
      if (okRows.length === 0) {
        alert('Nessuna riga valida da trasferire su QuickBooks.');
        return;
      }
      const btn = document.getElementById('transferToQbBtn') || document.getElementById('openTransferModalBtn');
      const originalText = btn.innerHTML;
      btn.disabled = true;
      btn.innerHTML = '‚è≥ Trasferimento in corso...';
      fetch('/trasferisci-ore-qb', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ rows: okRows })
      })
      .then(r => r.json())
      .then(js => {
        btn.disabled = false;
        btn.innerHTML = originalText;
        if (js.success) {
          // Aggiorna la modale con i risultati e i nomi sub-customer
          lastExcelImportReport = js.report;
          renderExcelImportModal(js.report);
          alert('‚úÖ Trasferimento completato!');
        } else {
          alert('‚ùå Errore trasferimento: ' + (js.error || js.message || 'Errore sconosciuto'));
        }
      })
      .catch(err => {
        btn.disabled = false;
        btn.innerHTML = originalText;
        alert('‚ùå Errore: ' + err);
      });
    }    // Event Listeners
    function initAppOnce() {
      if (appInitialized) return;
      appInitialized = true;

      setDefaultDates();
      
      // Event listeners per suggerimento automatico modalit√†
      document.getElementById('fromDate').addEventListener('change', suggestPaginationMode);
      document.getElementById('toDate').addEventListener('change', suggestPaginationMode);
      
      // Form importazione ORE
      document.getElementById("importForm").addEventListener("submit", function(e) {
        e.preventDefault();
        const from = document.getElementById("fromDate").value;
        const to = document.getElementById("toDate").value;
        
        if (!from || !to) {
          alert('‚ùå Seleziona le date');
          return;
        }
        
        // Chiedi il nome dell'employee per le ore
        const employeeName = prompt('üë§ Inserisci il nome dell employee per le ore:', 'GINUDDO');
        if (!employeeName) {
          alert('‚ùå Nome employee richiesto per importare le ore');
          return;
        }
        
        const confirmed = confirm('üïê Importare ore per tutti i progetti dal ' + from + ' al ' + to + '?\n\nüë§ Employee: ' + employeeName + '\n\n‚ö†Ô∏è L operazione potrebbe richiedere diversi minuti.');
        if (!confirmed) return;
        
        // Disabilita il pulsante durante l'importazione
        const btn = e.target.querySelector('button[type="submit"]');
        const originalText = btn.innerHTML;
        btn.disabled = true;
        btn.innerHTML = '<span>‚è≥</span> Importazione in corso...';
        
        fetch("/avvia-importazione", {
          method: "POST",
          headers: {"Content-Type": "application/json"},
          body: JSON.stringify({ fromDate: from, toDate: to, employeeName: employeeName })
        })
        .then(function(r) { return r.json(); })
        .then(function(js) {
          // Riabilita il pulsante
          btn.disabled = false;
          btn.innerHTML = originalText;
          
          if (js.success) {
            alert('‚úÖ ' + (js.message || "Importazione ore completata con successo"));
          } else {
            alert('‚ùå Errore importazione ore: ' + (js.error || js.message || 'Errore sconosciuto'));
          }
          
          // Log dettagliato
          if (js.output) {
            console.log('üìÑ Output importazione ore:', js.output);
          }
        })
        .catch(function(err) {
          // Riabilita il pulsante
          btn.disabled = false;
          btn.innerHTML = originalText;
          alert('‚ùå Errore: ' + err);        });
      });      // Gestione modalit√† caricamento
      document.querySelectorAll('input[name="loadingMode"]').forEach(function(radio) {
        radio.addEventListener('change', function() {
          const pageSize = document.getElementById('pageSize');
          const isPaginated = this.value === 'paginated';
          pageSize.disabled = !isPaginated;
          pageSize.style.opacity = isPaginated ? '1' : '0.5';
          
          // Aggiorna il testo del pulsante
          const btn = document.getElementById('listProjectsBtn');
          if (isPaginated) {
            btn.innerHTML = '<span>‚ö°</span> Recupera Lista Progetti (Paginato)';
          } else {
            btn.innerHTML = '<span>üìã</span> Recupera Lista Progetti';
          }
        });
      });

      // Lista progetti
      document.getElementById("listProjectsBtn").addEventListener("click", function() {
        console.log("üöÄ INIZIO - Pulsante cliccato");
        
        const from = document.getElementById("fromDate").value;
        const to = document.getElementById("toDate").value;
        const tbody = document.querySelector("#projectList tbody");
        
        console.log("üìÖ Date selezionate:", { from: from, to: to });
        
        // Modalit√† solo paginata
        const endpoint = '/lista-progetti-paginati';
        const pageSize = parseInt(document.getElementById('pageSize').value);
        
        console.log(`üöÄ Modalit√† caricamento: paginata (endpoint: ${endpoint})`);
        console.log(`üìÑ Page size: ${pageSize}`);
        console.log("‚è≥ Inizio caricamento...");
        tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 3rem;">‚è≥ Caricamento...</td></tr>';
        
        // Reset performance info e statistiche durante il caricamento
        document.getElementById('performanceInfo').style.display = 'none';
        document.getElementById('loadTime').textContent = '-';
        
        console.log("üåê Invio richiesta al server...");
        
        // Prepara payload
        const projectNumber = document.getElementById("projectNumber") ? document.getElementById("projectNumber").value.trim() : "";
        let requestBody;
        if (projectNumber) {
          requestBody = { projectNumber: projectNumber, pageSize: pageSize };
        } else {
          if (!from || !to) {
            console.log("‚ùå Date mancanti");
            alert('‚ùå Seleziona le date per recuperare i progetti');
            return;
          }
          requestBody = { fromDate: from, toDate: to, pageSize: pageSize };
        }
        
        const startTime = performance.now();
        
        fetch(endpoint, {
          method: "POST",
          headers: {"Content-Type": "application/json"},
          body: JSON.stringify(requestBody)
        })
        .then(function(r) {
          console.log("üì° Risposta ricevuta, status:", r.status);
          return r.json();
        })
        .then(function(js) {
          // Ordina i progetti per id crescente
          if (js.projects && Array.isArray(js.projects)) {
            js.projects.sort(function(a, b) {
              // Se id √® numerico, ordina come numero, altrimenti come stringa
              if (!isNaN(a.id) && !isNaN(b.id)) {
                return Number(a.id) - Number(b.id);
              }
              return (a.id + '').localeCompare(b.id + '');
            });
          }
          const endTime = performance.now();
          const clientDuration = ((endTime - startTime) / 1000).toFixed(2);
          
          console.log("üì• RICEVUTO DAL SERVER - Risposta completa:", js);
          
          // Log performance
          const projectCount = js.projects ? js.projects.length : 0;
          const serverDuration = js.pagination ? js.pagination.duration : 'N/A';
          
          console.log(`‚ö° PERFORMANCE (Paginata):`);
          console.log(`   üìä Progetti: ${projectCount}`);
          console.log(`   ‚è±Ô∏è Tempo client: ${clientDuration}s`);
          console.log(`   üñ•Ô∏è Tempo server: ${serverDuration}s`);
          if (projectCount > 0) {
            console.log(`   üìà Velocit√†: ${(projectCount / parseFloat(clientDuration)).toFixed(1)} progetti/sec`);
          }
          if (js.pagination) {
            console.log(`   üìÑ Page size: ${js.pagination.page_size}`);
          }
          
          // üîç DEBUG: Stampa i primi progetti ricevuti
          if (js.projects && js.projects.length > 0) {
            console.log("üì• RICEVUTO DAL SERVER - Debug primi 3 progetti:");
            js.projects.slice(0, 3).forEach(function(p, i) {
              console.log('  Progetto ' + (i+1) + ':');
              console.log('    ID: ' + p.id + ' (tipo: ' + typeof p.id + ')');
              console.log('    NUMBER: ' + p.number + ' (tipo: ' + typeof p.number + ')');
              console.log('    NAME: ' + p.name + ' (tipo: ' + typeof p.name + ')');
              console.log('    STATUS: ' + p.status + ' (tipo: ' + typeof p.status + ')');
              console.log('    Oggetto completo:', p);
            });
          } else {
            console.log("‚ö†Ô∏è Nessun progetto nell'array o array vuoto");
          }
          
          if (js.error) {
            console.log("‚ùå Errore dal server:", js.error);
            tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; color: #dc3545; padding: 3rem;">‚ö†Ô∏è Errore nel caricamento</td></tr>';
            alert('‚ùå Errore: ' + js.error);
            return;
          }
            if (!js.projects || js.projects.length === 0) {
            console.log("üìã Nessun progetto trovato");
            tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; color: #6c757d; padding: 3rem;">üìã Nessun progetto trovato</td></tr>';
            
            // Prepara i dati di performance anche per zero risultati
            const performanceData = {
              loadTime: clientDuration,
              projects: 0,
              speed: 0,
              mode: 'Paginata'
            };
            
            updateStats(0, 0, 0, performanceData);
            return;
          }
          
          console.log("üî® INIZIO RENDERING di", js.projects.length, "progetti");
          tbody.innerHTML = "";
          let activeCount = 0;
          
          console.log("üî® CREAZIONE RIGHE - Debug rendering:");
          js.projects.forEach(function(p, index) {
            // üîç DEBUG: Per ogni progetto durante il rendering
            if (index < 3) {
              console.log('  üî® Rendering progetto ' + (index + 1) + ':');
              console.log('    p.id: ' + p.id);
              console.log('    p.number: ' + p.number);
              console.log('    p.number || "N/A": ' + (p.number || 'N/A'));
              console.log('    Condizione (p.number || "N/A"): ' + (p.number || 'N/A'));
            }
            
            // DEBUG: Mostra tutto l'oggetto progetto ricevuto
            console.log('DEBUG PAYLOAD PROGETTO:', p);
            
            if (p.status && !['Annullato', 'Rientrato'].includes(p.status)) {
              activeCount++;
            }
            
            const statusBadge = getStatusBadge(p.status);
            const tr = document.createElement("tr");
            
            // üîç DEBUG: Valore finale che finisce nell'HTML
            const finalNumber = p.number || 'N/A';
            if (index < 3) {
              console.log('    üíª Valore finale nell HTML: "' + finalNumber + '"');
            }
            
            tr.innerHTML = '<td><input type="checkbox" class="project-checkbox" data-project-id="' + p.id + '" data-project-name="' + p.name + '"></td>' +
              '<td><strong>' + (p.id || 'N/A') + '</strong></td>' +
              '<td><code>' + (p.number || 'N/A') + '</code></td>' +
              '<td style="max-width: 300px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="' + (p.name || 'N/A') + '">' +
                '<a href="#" class="project-link" data-project-id="' + p.id + '">' + (p.name || 'N/A') + '</a>' +
                ((p.equipment_period_from && p.equipment_period_to) ?
                  '<br><span style="font-size: 0.8em; color: #888; font-style: italic;">' +
                    p.equipment_period_from + ' ‚Üí ' + p.equipment_period_to +
                  '</span>' :
                  '') +
                (p.project_type_name ?
                  '<br><span style="font-size: 0.8em; color: #888; font-style: italic;">' +
                    p.project_type_name +
                  '</span>' :
                  '') +
              '</td>' +
              // Cliente
              '<td title="Valore grezzo: ' + String(p.cliente) + '"' +
                ((!p.cliente || p.cliente === '-' || p.cliente === '' || p.cliente === 'N/A') ? ' style="background:#ffcccc;color:#b71c1c;font-weight:bold;"' : '') +
                '>' + (p.cliente ? p.cliente : '-') + '</td>' +
              // Stato
              '<td>' + statusBadge + '</td>' +
              // Responsabile
              '<td>' + (
                p.manager_name ?
                  '<strong>' + p.manager_name + '</strong>' +
                  (p.manager_email ? '<br><span style="font-size:0.85em;color:#555;">' + p.manager_email + '</span>' : '')
                : 'N/A') + '</td>' +
              // Valore
              (function() {
                let valore_grezzo = (p.project_total_price && p.project_total_price !== '0.00' && p.project_total_price !== 'N/A') ? p.project_total_price : p.project_value;
                let is_sospetto = (!valore_grezzo || valore_grezzo === '0.00' || valore_grezzo === 'N/A');
                let valore_formattato = '';
                if (valore_grezzo && valore_grezzo !== '0.00') {
                  let numero = parseFloat(valore_grezzo);
                  if (!isNaN(numero)) {
                    valore_formattato = '‚Ç¨ ' + numero.toLocaleString('it-IT', {minimumFractionDigits: 2, maximumFractionDigits: 2});
                  } else {
                    valore_formattato = '‚Ç¨ ' + valore_grezzo;
                  }
                } else {
                  valore_formattato = '<span style="color:#999;">N/A</span>';
                }
                return '<td style="text-align: right;' + (is_sospetto ? ' background:#ffcccc;color:#b71c1c;font-weight:bold;' : '') + '" title="Valore grezzo: ' + String(valore_grezzo) + '">' + valore_formattato + '</td>';
              })() +
              '<td>' + renderQbImportStatus(p.qb_import) + '</td>';
            tbody.appendChild(tr);
          });
          
          // üîó Collegamento eventi checkbox...
          attachCheckboxEvents();
          
          // üîó Collegamento eventi click sui link progetto per modale payload
          document.querySelectorAll('.project-link').forEach(function(link) {
            link.addEventListener('click', function(e) {
              e.preventDefault();
              const projectId = this.dataset.projectId;
              const modal = document.getElementById('projectModal');
              const pre = document.getElementById('projectPayload');
              pre.textContent = 'Caricamento...';
              modal.style.display = 'flex';
              fetch('/dettaglio-progetto/' + encodeURIComponent(projectId))
                .then(r => r.json())
                .then(data => {
                  pre.textContent = JSON.stringify(data, null, 2);
                })
                .catch(err => {
                  pre.textContent = 'Errore nel caricamento del payload: ' + err;
                });
            });
          });
          // Gestione chiusura modale
          document.getElementById('closeProjectModal').onclick = function() {
            document.getElementById('projectModal').style.display = 'none';
          };
          // Chiudi modale cliccando fuori dal contenuto
          document.getElementById('projectModal').addEventListener('click', function(e) {
            if (e.target === this) this.style.display = 'none';
          });          console.log("üìä Aggiornamento statistiche...");
          
          // Prepara i dati di performance
          const performanceData = {
            loadTime: clientDuration,
            projects: js.projects.length,
            speed: js.projects.length > 0 ? (js.projects.length / parseFloat(clientDuration)).toFixed(1) : 0,
            mode: 'Paginata'
          };
          
          updateStats(js.projects.length, 0, activeCount, performanceData);
          
          console.log("‚úÖ COMPLETATO rendering di", js.projects.length, "progetti");
        })
        .catch(function(err) {
          console.error("üí• ERRORE nella richiesta:", err);
          tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; color: #dc3545; padding: 3rem;">üîå Errore connessione</td></tr>';
          alert('‚ùå Errore di connessione');
        });
      });

      // Seleziona tutti
      document.getElementById('selectAll').addEventListener('change', function() {
        const checkboxes = document.querySelectorAll('.project-checkbox');
        const rows = document.querySelectorAll('#projectList tbody tr');
        
        checkboxes.forEach(function(checkbox, index) {
          checkbox.checked = this.checked;
          if (this.checked) {
            rows[index].classList.add('selected-row');
          } else {
            rows[index].classList.remove('selected-row');
          }
        }.bind(this));
        updateSelectedCount();
      });

      // Elabora selezionati (SOLO FATTURE)
      document.getElementById('processSelectedBtn').addEventListener('click', function() {
        const selectedCheckboxes = document.querySelectorAll('.project-checkbox:checked');
        const selectedProjects = Array.from(selectedCheckboxes).map(function(checkbox) {
          return {
            id: checkbox.dataset.projectId,
            name: checkbox.dataset.projectName
          };
        });
        if (selectedProjects.length === 0) {
          alert('‚ö†Ô∏è Nessun progetto selezionato!');
          return;
        }
        const projectList = selectedProjects.map(function(p) {
          return '‚Ä¢ ' + p.name + ' (ID: ' + p.id + ')';
        }).join('\n');
        const confirmed = confirm('üí∞ Elaborare FATTURE per ' + selectedProjects.length + ' progetti selezionati?\n\n' + projectList + '\n\nüìù Nota: Questa operazione crea solo Customer/Sub-customer e Fatture.\nPer importare le ore, usa "Avvia Importazione Ore".\n\n‚ö†Ô∏è L operazione potrebbe richiedere diversi minuti.');
        if (confirmed) {
          // Disabilita il pulsante durante l'elaborazione
          const btn = document.getElementById('processSelectedBtn');
          const originalText = btn.innerHTML;
          btn.disabled = true;
          btn.innerHTML = '<span>‚è≥</span> Elaborazione fatture...';
          console.log('üí∞ Invio richiesta elaborazione fatture:', selectedProjects);
          fetch('/elabora-selezionati', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
              selectedProjects: selectedProjects
            })
          })
          .then(function(r) { return r.json(); })
          .then(function(response) {
            console.log('üì• Risposta elaborazione fatture:', response);
            // Riabilita il pulsante
            btn.disabled = false;
            btn.innerHTML = originalText;
            if (response.success) {
              // Mostra risultati dettagliati
              const summary = response.summary;
              let message = '‚úÖ Elaborazione fatture completata!\n\n';
              message += 'üìä Risultati:\n';
              message += '   ‚Ä¢ Totali: ' + summary.total + '\n';
              message += '   ‚Ä¢ Successi: ' + summary.success + '\n';
              message += '   ‚Ä¢ Simulati: ' + summary.simulated + '\n';
              message += '   ‚Ä¢ Errori: ' + summary.errors + '\n';
              message += '   ‚Ä¢ Timeout: ' + summary.timeouts + '\n';
              message += '\nüí° Per importare le ore, usa "Avvia Importazione Ore"';
              alert(message);
              // Log dettagliato in console
              console.log('üìã Risultati dettagliati per progetto:');
              response.results.forEach(function(result, index) {
                let statusText = result.status.toUpperCase();
                if (result.status === 'success_simulated') {
                  statusText = 'SIMULATO';
                }
                console.log('  ' + (index + 1) + '. ' + result.project_name + ' (' + result.project_id + '): ' + statusText);
                if (result.message) {
                  console.log('     ‚ÑπÔ∏è ' + result.message);
                }
                if (result.error) {
                  console.error('     ‚ùå Errore: ' + result.error);
                }
              });
              // AGGIUNTA: aggiorna la lista progetti dopo l'elaborazione
              document.getElementById('listProjectsBtn').click();
            } else {
              alert('‚ùå Errore durante l elaborazione fatture: ' + (response.error || 'Errore sconosciuto'));
            }
          })
          .catch(function(err) {
            // Riabilita il pulsante
            btn.disabled = false;
            btn.innerHTML = originalText;
            alert('‚ùå Errore di connessione durante l elaborazione fatture');
          });
        }
      });
      
      // Importazione ore da Excel
      document.getElementById('importExcelBtn').addEventListener('click', function() {
        const fileInput = document.getElementById('excelFile');
        const file = fileInput.files[0];
        const msgDiv = document.getElementById('importExcelMsg');
        msgDiv.textContent = '';
        msgDiv.style.color = '';
        if (!file) {
          msgDiv.textContent = '‚ùå Seleziona un file Excel da importare';
          msgDiv.style.color = '#e74c3c';
          return;
        }
        const dataAttivita = document.getElementById('excelDataAttivita').value;
        if (!dataAttivita) {
          msgDiv.textContent = '‚ùå Data attivit√† obbligatoria per l\'importazione Excel';
          msgDiv.style.color = '#e74c3c';
          return;
        }
        const btn = document.getElementById('importExcelBtn');
        const originalText = btn.innerHTML;
        btn.disabled = true;
        btn.innerHTML = '<span>‚è≥</span> Importazione in corso...';
        const formData = new FormData();
        formData.append('excelFile', file);
        formData.append('data_attivita', dataAttivita);
        fetch('/importa-ore-excel', {
          method: 'POST',
          body: formData
        })
        .then(r => r.json())
        .then(js => {
          btn.disabled = false;
          btn.innerHTML = originalText;
          if (js.success) {
            msgDiv.textContent = '‚úÖ Importazione completata: ' + js.message;
            msgDiv.style.color = '#27ae60';
          } else {
            msgDiv.textContent = '‚ùå Errore importazione: ' + (js.error || js.message || 'Errore sconosciuto');
            msgDiv.style.color = '#e74c3c';
          }
        })
        .catch(err => {
          btn.disabled = false;
          btn.innerHTML = originalText;
          msgDiv.textContent = '‚ùå Errore: ' + err;
          msgDiv.style.color = '#e74c3c';
        });
      });      // Pulsante per aprire la pagina di conversione XML ‚Üí CSV
      document.getElementById('xmlToCsvBtn').addEventListener('click', function() {
        window.location.href = 'xml-to-csv.html'; // Apri nella stessa scheda
      });
      
      // Pulsante per aprire la pagina di ricerca fatture
      document.getElementById('searchBillsBtn').addEventListener('click', function() {
        window.location.href = 'search-bills.html'; // Apri nella stessa scheda
      });
    }

    document.addEventListener('DOMContentLoaded', function() {
      setupLoginUI();
      ensureAuthThenInit();
    });
    
    function renderQbImportStatus(qbImport) {
      if (!qbImport) return '<span style="color:#888;">-</span>';
      if (qbImport.status === 'success' || qbImport.status === 'success_simulated') {
        return '<span style="color:#27ae60;font-weight:bold;">OK</span>' + (qbImport.timestamp ? '<br><span style="font-size:0.8em;color:#888;">' + qbImport.timestamp.replace('T',' ') + '</span>' : '');
      }
      if (qbImport.status === 'timeout') {
        return '<span style="color:#e67e22;font-weight:bold;">Timeout</span>' + (qbImport.timestamp ? '<br><span style="font-size:0.8em;color:#888;">' + qbImport.timestamp.replace('T',' ') + '</span>' : '');
      }
      if (qbImport.status === 'error') {
        return '<span style="color:#e74c3c;font-weight:bold;">Errore</span>' + (qbImport.message ? '<br><span style="font-size:0.85em;color:#e74c3c;">' + qbImport.message + '</span>' : '') + (qbImport.timestamp ? '<br><span style="font-size:0.8em;color:#888;">' + qbImport.timestamp.replace('T',' ') + '</span>' : '');
      }
      return '<span style="color:#888;">-</span>';
    }
  </script>
</body>
</html>
